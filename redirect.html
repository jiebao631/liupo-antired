<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>链接跳转中...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="color-scheme" content="light dark" />
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/iosxlb/static@main/favicon/link.ico" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <style>
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen flex items-center justify-center px-4 font-sans">
    <div class="container max-w-md w-full">
        <!-- 跳转卡片 -->
        <div id="redirectCard" class="bg-white/90 rounded-3xl shadow-xl overflow-hidden backdrop-blur-2xl border border-gray-200">
            <!-- 顶部装饰 -->
            <div class="h-2 bg-gradient-to-r from-blue-500 to-blue-400"></div>
            
            <!-- 内容区域 -->
            <div class="p-6 text-center">
                <!-- Logo -->
                <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 flex items-center justify-center rounded-full bg-blue-500 shadow-lg text-white text-3xl">
                        <i class="fa fa-external-link"></i>
                    </div>
                </div>
                
                <!-- 标题 -->
                <h1 class="text-xl font-bold text-gray-800 mb-2">正在跳转...</h1>
                <p class="text-gray-600 text-sm mb-6">请稍候，正在为您跳转到目标页面</p>
                
                <!-- 加载动画 -->
                <div class="mb-6">
                    <div class="inline-block relative w-20 h-20">
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-blue-100 rounded-full"></div>
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fa fa-spinner text-blue-500 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 目标链接显示 -->
                <div id="targetInfo" class="hidden mb-6 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-xs text-gray-500 mb-1">即将跳转到：</p>
                    <p id="targetUrlText" class="text-sm text-blue-700 break-all font-medium"></p>
                </div>
                
                <!-- 倒计时 -->
                <div class="mb-6">
                    <div class="text-gray-700 text-sm mb-2">
                        <span id="countdown">5</span> 秒后自动跳转
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-blue-400 h-2 rounded-full transition-all duration-1000 ease-linear" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 安全提示 -->
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded mb-6 text-left">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa fa-shield text-yellow-500 mt-0.5"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700 font-medium">安全提示</p>
                            <p class="text-xs text-yellow-600 mt-1">请确保目标链接安全可靠，注意保护个人信息</p>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="space-y-3">
                    <button id="jumpNowBtn" onclick="jumpNow()" class="w-full py-3 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold shadow-md hover:shadow-lg transition-all duration-300">
                        <i class="fa fa-external-link mr-2"></i> 立即跳转
                    </button>
                    <button id="cancelBtn" onclick="cancelJump()" class="w-full py-3 rounded-lg bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold shadow hover:shadow-md transition-all duration-300">
                        <i class="fa fa-times mr-2"></i> 取消跳转
                    </button>
                </div>
                
                <!-- 返回首页链接 -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <a href="index.html" class="text-blue-500 hover:text-blue-600 text-sm font-medium transition-colors">
                        <i class="fa fa-arrow-left mr-1"></i> 返回首页生成新链接
                    </a>
                </div>
            </div>
            
            <!-- 底部信息 -->
            <div class="bg-gray-50 p-4 text-center">
                <p class="text-xs text-gray-500">防红链接生成器 · 安全跳转服务</p>
                <p class="text-xs text-gray-400 mt-1">本服务仅用于合法链接跳转</p>
            </div>
        </div>
        
        <!-- 错误提示卡片 -->
        <div id="errorCard" class="hidden bg-white/90 rounded-3xl shadow-xl overflow-hidden backdrop-blur-2xl border border-gray-200 mt-6">
            <div class="h-2 bg-gradient-to-r from-red-500 to-red-400"></div>
            <div class="p-6 text-center">
                <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 flex items-center justify-center rounded-full bg-red-500 shadow-lg text-white text-3xl">
                        <i class="fa fa-exclamation-triangle"></i>
                    </div>
                </div>
                <h1 class="text-xl font-bold text-gray-800 mb-2">跳转失败</h1>
                <p id="errorMessage" class="text-gray-600 text-sm mb-6">无法获取有效的目标链接</p>
                <div class="space-y-3">
                    <a href="index.html" class="block w-full py-3 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold shadow-md hover:shadow-lg transition-all duration-300">
                        <i class="fa fa-home mr-2"></i> 返回首页
                    </a>
                    <button onclick="location.reload()" class="w-full py-3 rounded-lg bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold shadow hover:shadow-md transition-all duration-300">
                        <i class="fa fa-refresh mr-2"></i> 重新加载
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let countdownTime = 5;
        let countdownInterval;
        let targetUrl = '';
        let isCancelled = false;
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const encodedUrl = urlParams.get('url');
            
            if (!encodedUrl) {
                showError('未找到跳转参数，请返回首页重新生成链接。');
                return;
            }
            
            try {
                // Base64解码（与index.html中的编码方式对应）
                targetUrl = decodeBase64(encodedUrl);
                
                // 验证URL格式
                if (!isValidUrl(targetUrl)) {
                    showError('目标链接格式不正确，请检查后重试。');
                    return;
                }
                
                // 显示目标链接（截断处理）
                const displayUrl = targetUrl.length > 50 ? targetUrl.substring(0, 50) + '...' : targetUrl;
                document.getElementById('targetUrlText').textContent = displayUrl;
                document.getElementById('targetInfo').classList.remove('hidden');
                
                // 开始倒计时
                startCountdown();
                
                // 设置页面标题显示目标域名
                try {
                    const urlObj = new URL(targetUrl);
                    document.title = `跳转到 ${urlObj.hostname}...`;
                } catch (e) {
                    // 忽略错误
                }
                
            } catch (error) {
                console.error('URL解码错误:', error);
                showError('链接解析失败，请确保链接完整有效。');
            }
        });
        
        // Base64解码函数（与index.html中的编码对应）
        function decodeBase64(encodedStr) {
            try {
                // 标准Base64解码
                const binaryStr = atob(encodedStr);
                // 将二进制字符串转换为URI编码的字符串
                const uriEncoded = binaryStr.split('').map(char => {
                    return '%' + ('00' + char.charCodeAt(0).toString(16)).slice(-2);
                }).join('');
                
                // 解码URI组件
                return decodeURIComponent(uriEncoded);
            } catch (error) {
                console.error('解码失败:', error);
                // 尝试直接解码
                try {
                    return atob(encodedStr);
                } catch (e) {
                    throw new Error('无法解码URL参数');
                }
            }
        }
        
        // 验证URL格式
        function isValidUrl(url) {
            try {
                const urlObj = new URL(url);
                // 只允许http和https协议
                return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch {
                return false;
            }
        }
        
        // 开始倒计时
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            const progressBar = document.getElementById('progressBar');
            
            // 初始化
            countdownTime = 5;
            countdownElement.textContent = countdownTime;
            progressBar.style.width = '0%';
            
            // 清空之前的计时器
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // 开始计时
            countdownInterval = setInterval(() => {
                if (isCancelled) {
                    clearInterval(countdownInterval);
                    return;
                }
                
                countdownTime--;
                countdownElement.textContent = countdownTime;
                const progressPercent = 100 - (countdownTime * 20); // 5秒 = 100%
                progressBar.style.width = `${progressPercent}%`;
                
                if (countdownTime <= 0) {
                    clearInterval(countdownInterval);
                    jumpNow();
                }
            }, 1000);
        }
        
        // 立即跳转
        function jumpNow() {
            if (!targetUrl || isCancelled) return;
            
            // 添加跳转前提示
            const jumpBtn = document.getElementById('jumpNowBtn');
            const originalText = jumpBtn.innerHTML;
            jumpBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 跳转中...';
            jumpBtn.disabled = true;
            
            // 短暂延迟后跳转，让用户看到反馈
            setTimeout(() => {
                // 记录跳转日志（可选）
                console.log(`跳转到: ${targetUrl}`);
                
                // 安全跳转，使用noreferrer和noopener防止安全风险
                window.location.replace(targetUrl);
                
                // 如果replace不起作用，备用方案
                setTimeout(() => {
                    window.location.href = targetUrl;
                }, 1000);
            }, 500);
        }
        
        // 取消跳转
        function cancelJump() {
            isCancelled = true;
            
            // 停止倒计时
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // 更新UI
            document.getElementById('redirectCard').style.opacity = '0.7';
            document.getElementById('jumpNowBtn').disabled = true;
            document.getElementById('cancelBtn').innerHTML = '<i class="fa fa-check mr-2"></i> 已取消';
            document.getElementById('cancelBtn').classList.remove('from-gray-500', 'to-gray-600');
            document.getElementById('cancelBtn').classList.add('from-green-500', 'to-green-600');
            document.getElementById('cancelBtn').disabled = true;
            
            // 显示提示
            showToast('已取消跳转，您可以选择返回首页', 'info');
        }
        
        // 显示错误
        function showError(message) {
            document.getElementById('redirectCard').classList.add('hidden');
            document.getElementById('errorCard').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        // 显示提示
        function showToast(message, type = 'info') {
            // 创建临时提示元素
            const toast = document.createElement('div');
            let bgColor = 'bg-blue-500';
            
            switch(type) {
                case 'success': bgColor = 'bg-green-500'; break;
                case 'error': bgColor = 'bg-red-500'; break;
                case 'warning': bgColor = 'bg-yellow-500'; break;
                case 'info': bgColor = 'bg-blue-500'; break;
            }
            
            toast.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 text-white font-medium text-sm ${bgColor} animate-fadeIn`;
            toast.textContent = message;
            toast.id = 'tempToast';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // 添加淡入动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translate(-50%, 10px); }
                to { opacity: 1; transform: translate(-50%, 0); }
            }
            .animate-fadeIn {
                animation: fadeIn 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);
        
        // 禁止右键和选择
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
        
        // 防止返回按钮导致重复跳转
        window.history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', () => {
            window.history.pushState(null, null, window.location.href);
        });
    </script>
</body>
</html>